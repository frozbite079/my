{% extends 'base.html' %}
{% load static %}
{% load sass_tags %}

{% block css %}
<!-- Plugins css start-->
<link rel="stylesheet" type="text/css" href="{% sass_src 'assets/scss/vendors/datatables.scss' %}">
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
<!-- Plugins css Ends--> 
{% endblock %}
{% block title %}User List{% endblock %}

{% block content %}
<div class="page-body">
   <div class="container-fluid">
    {% include "layouts/breadcrumb.html" %}
      <div class="row">
         <div class="col-sm-12">
            <div class="card">
               <div class="card-body">
                  <div class="table-responsive">
                     <table class="display" id="basic-1">
                        <thead>
                           <tr>
                              <th>Username</th>
                              <th>First Name</th>
                              <th>Last Name</th>
                              <th>Email</th>
                              <th>Phone</th>
                              <th>Status</th>
                              <th>Role</th>
                              <th>Actions</th>
                           </tr>
                        </thead>
                        <tbody> 
                           {% for user in users %}
                           <tr>
                              <td>{{ user.username }}</td>
                              <td>{{ user.first_name }}</td>
                              <td>{{ user.last_name }}</td>
                              <td>{{ user.email }}</td>
                              <td>{{ user.phone }}</td>
                              <td>
                                 {% if user.is_active %}
                                    <button class="btn btn-success toggle-status" 
                                            data-user-id="{{ user.id }}" 
                                            data-status="deactivate">Active</button>
                                 {% else %}
                                    <button class="btn btn-danger toggle-status" 
                                            data-user-id="{{ user.id }}" 
                                            data-status="activate">Deactive</button>
                                 {% endif %}
                              </td>
                              {% if user.role %}
                              <td>{{ user.role.name }}</td>
                              {% else %}
                              <td>No Role Assigned</td>
                              {% endif %}
                              <td>
                                 <ul class="action">
                                    <li class="edit">
                                       <a href="#" data-id="{{ user.id }}" class="edit-btn">
                                          <i class="icon-pencil-alt"></i>
                                       </a>
                                    </li>
                                    <li class="delete">
                                       <a href="#" data-id="{{ user.id }}" class="delete-btn">
                                          <i class="icon-trash"></i>
                                       </a>
                                    </li>
                                 </ul>
                              </td>
                           </tr>
                           {% endfor %}
                        </tbody>
                     </table>
                  </div>
               </div>
            </div>
         </div>
      </div>
   </div>
</div>

<!-- Edit User Modal -->
<div class="modal fade" id="editUserModal" tabindex="-1" role="dialog" aria-labelledby="editUserModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editUserModalLabel">Edit User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editUserForm" method="post">
                    {% csrf_token %}
                    <input type="hidden" name="user_id" id="user_id">
                    <div class="mb-3">
                        <label class="form-label" for="first_name">First Name</label>
                        <input class="form-control" id="first_name" name="first_name" type="text">
                        <div class="text-danger" id="first_name_error"></div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label" for="last_name">Last Name</label>
                        <input class="form-control" id="last_name" name="last_name" type="text">
                        <div class="text-danger" id="last_name_error"></div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label" for="email">Email</label>
                        <input class="form-control" id="email" name="email" type="email">
                        <div class="text-danger" id="email_error"></div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label" for="phone">Phone</label>
                        <input class="form-control" id="phone" name="phone" type="text">
                        <div class="text-danger" id="phone_error"></div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label" for="role">Role</label>
                        <select class="form-control" id="role" name="role">
                            {% for role in roles %}
                                <option value="{{ role.id }}">{{ role.name }}</option>
                            {% endfor %}
                        </select>
                        <div class="text-danger" id="role_error"></div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" aria-label="Close">Close</button>
                <button class="btn btn-primary" type="submit" form="editUserForm">Save</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete User Modal -->
<div class="modal fade" id="deleteUserModal" tabindex="-1" aria-labelledby="deleteUserModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteUserModalLabel">Delete User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form method="post" id="deleteUserForm">
                    {% csrf_token %}
                    <input type="hidden" id="deleteUserId" name="id">
                    <p>Are you sure you want to delete this user?</p>
                    <button type="submit" class="btn btn-danger">Delete User</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scriptcontent %}
<!-- Plugins JS start-->
<script src="{% static 'assets/js/datatable/datatables/jquery.dataTables.min.js' %}"></script>
<script src="{% static 'assets/js/datatable/datatables/datatable.custom.js' %}"></script>
<script src="{% static 'assets/js/tooltip-init.js' %}"></script>
<!-- Plugins JS Ends-->

<script>
document.addEventListener('DOMContentLoaded', function () {
    // Edit button click handler
    document.querySelectorAll('.edit-btn').forEach(function (button) {
        button.addEventListener('click', function (e) {
            e.preventDefault();
            var userId = this.getAttribute('data-id');
            
            // Fetch user details
            fetch('/users/' + userId + '/edit/')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('user_id').value = data.id;
                    document.getElementById('first_name').value = data.first_name;
                    document.getElementById('last_name').value = data.last_name;
                    document.getElementById('email').value = data.email;
                    document.getElementById('phone').value = data.phone;

                    // Set selected role
                    var roleSelect = document.getElementById('role');
                    roleSelect.value = data.role || '';

                    // Show modal using Bootstrap
                    $('#editUserModal').modal('show');
                });
        });
    });

    // Edit user form submit with validation error handling
    document.getElementById('editUserForm').addEventListener('submit', function (e) {
        e.preventDefault();
        var formData = new FormData(this);
        fetch('/users/' + document.getElementById('user_id').value + '/update/', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();  // Reload the page to see changes
            } else {
                // Clear previous errors
                document.querySelectorAll('.text-danger').forEach(function(el) {
                    el.textContent = '';
                });
                // Display errors
                if (data.errors.first_name) {
                    document.getElementById('first_name_error').textContent = data.errors.first_name;
                }
                if (data.errors.last_name) {
                    document.getElementById('last_name_error').textContent = data.errors.last_name;
                }
                if (data.errors.email) {
                    document.getElementById('email_error').textContent = data.errors.email;
                }
                if (data.errors.phone) {
                    document.getElementById('phone_error').textContent = data.errors.phone;
                }
                if (data.errors.role) {
                    document.getElementById('role_error').textContent = data.errors.role;
                }
            }
        });
    });

    // Delete button click handler
    document.querySelectorAll('.delete-btn').forEach(function (button) {
        button.addEventListener('click', function (e) {
            e.preventDefault();
            var userId = this.getAttribute('data-id');
            document.getElementById('deleteUserId').value = userId;
            $('#deleteUserModal').modal('show');
        });
    });

    // Delete user form submit
    document.getElementById('deleteUserForm').addEventListener('submit', function (e) {
        e.preventDefault();
        var formData = new FormData(this);
        fetch('/users/' + document.getElementById('deleteUserId').value + '/delete/', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            location.reload();  // Reload the page after deletion
        });
    });

    // Toggle User Status
    document.querySelectorAll('.toggle-status').forEach(function (button) {
        button.addEventListener('click', function () {
            var userId = button.getAttribute('data-user-id');
            var status = button.getAttribute('data-status');
            var url = "{% url 'user_toggle_status' pk='0' %}".replace('0', userId);
    
            var form = document.createElement('form');
            form.method = 'POST';
            form.action = url;
    
            var csrfToken = document.createElement('input');
            csrfToken.type = 'hidden';
            csrfToken.name = 'csrfmiddlewaretoken';
            csrfToken.value = '{{ csrf_token }}';
            form.appendChild(csrfToken);
    
            var statusInput = document.createElement('input');
            statusInput.type = 'hidden';
            statusInput.name = 'status';
            statusInput.value = status;
            form.appendChild(statusInput);
    
            document.body.appendChild(form);
            form.submit();
        });
    });
});
</script>
{% endblock %}
